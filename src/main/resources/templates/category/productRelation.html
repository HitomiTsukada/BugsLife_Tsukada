<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>

<!-- 課題１１ -->
<head>
  <!-- Other head elements -->

  <!-- Include jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

  <th:block layout:fragment="content">
    <div id="success-message" class="alert alert-success" role="alert" style="display: none; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
    <div id="error-message" class="alert alert-danger" role="alert"  style="display: none; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
    <h1>カテゴリー - 商品設定</h1>
    <hr />
    <div id="categoryId" data-th-var="category.id" data-th-val="${category.id}"></div>
    <div id="action" data-th-var="action" data-th-val="${action}"></div>
    <div class="form-group">
      <label for="name">カテゴリー名: </label>
      <span th:text="${category.name}"></span>
    </div>
    <div class="form-group">
      <label for="description">説明: </label>
      <span th:text="${category.description}"></span>
    </div>
    <hr />

   <!-- 課題１１ -->
    <!-- <div class="form-group">
      <label for="products">紐付商品一覧: </label>
      <div class="d-inline" th:each="product : ${products}">
          <input class="form-check-input" type="checkbox" 
           th:id="'checkbox-' + ${product.id}" th:value="${product.id}"
           th:checked="${#lists.contains(associatedProductIds, product.id)}" />
          <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
          <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.id}"></label>
          <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${associatedProductIds}"></label>
      </div>
  </div> -->

  <!-- <div class="form-group">
    <label for="products">紐付商品一覧: </label>
    <div class="d-inline" th:each="productoo : ${associatedProductIds}" >
        <input class="form-check-input" type="checkbox" 
         th:id="'checkbox-' + ${productoo.id}" th:value="${productoo.id}"
         th:checked="${#lists.contains(associatedProductIds, productoo.id)}" />
        <label class="form-check-label" th:for="'checkbox-' + ${productoo.id}" th:text="${productoo.productId}"></label>
        <label class="form-check-label" th:for="'checkbox-' + ${productoo.id}" th:text="${associatedProductIds}"></label>
    </div>
</div> -->

<!-- <div class="form-group">
  <label for="products">紐付商品一覧: </label>

  
  <div class="d-inline" th:each="product : ${products}">
    <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}" />
    <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
    <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.id}"></label>
  </div>

  <div class="d-inline" th:each="associatedProduct : ${associatedProductIds}">
     <input class="form-check-input" type="checkbox" 
           th:id="'checkbox-' + ${associatedProduct.id}" th:value="${associatedProduct.id}"
           th:checked="${#lists.contains(associatedProductIds, associatedProduct.id)}" />
    <label class="form-check-label" th:for="'checkbox-' + ${associatedProduct.id}" th:text="${associatedProduct.productId}"></label>
  </div>

</div> -->

<!-- <div class="form-group">
  <label for="products">紐付商品一覧: </label>

  <div class="d-inline" th:each="product : ${products}">
    <div class="d-inline" th:each="associatedProduct : ${associatedProductIds}">
      <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}"
        th:checked="${associatedProduct.productId == product.id}"/>
      <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
    </div>
  </div>
</div> -->

<!-- <div class="form-group">
  <label for="products">紐付商品一覧: </label>

  <div class="d-inline" th:each="product : ${products}">
     <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}" />
    <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label> 
    
    <th:block th:each="associatedProduct : ${associatedProductIds}">
      <th:block th:if="${associatedProduct.productId == product.id}">
          <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}"
          checked />
          <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
      </th:block>
    </th:block>

  </div>
</div> -->

<div class="form-group">
  <label for="products">紐付商品一覧: </label>

  <div class="d-inline" th:each="product : ${products}">
      <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}" />
      <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
      
      <script th:inline="javascript">
        /*<![CDATA[*/
        var productId = /*[[${product.id}]]*/ 0; // 商品ID
        var associatedProductIds = /*[[${associatedProductIds}]]*/ []; // 紐付商品IDのリスト

        var productIds = associatedProductIds.map(function (product) {
        return product.productId;
        });
        
        console.log("商品Id： " + productId);
        console.log("商品Id一覧： " + productIds);
        
        productIds.forEach(function (associatedProductId) {
            console.log("商品Id一覧： " + associatedProductId);
        });
    
        if (productIds.includes(productId)) {
          document.getElementById('checkbox-' + productId).checked = true;
        }
        /*]]>*/
    </script>
  </div>
</div>







      <!-- 課題１１ -->
    <!-- <div class="form-group">
      <label for="products">紐付商品一覧: </label>
      <div class="d-inline" th:each="product : ${products}">
        <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${product.id}" th:value="${product.id}" />
        <label class="form-check-label" th:for="'checkbox-' + ${product.id}" th:text="${product.name}"></label>
      </div>
    </div> -->

      <!-- 課題１１ -->
  <script>
    function updateCategoryProducts() {
            // Retrieve category ID and convert to Long
            var categoryIdString = document.getElementById("categoryId").getAttribute("val"); 
            // data-th-val
            console.log(categoryIdString); 
            var categoryId = parseInt(categoryIdString, 10);  // 10は基数（10進数）

            // Retrieve selected product IDs
            var selectedProductIds = [];
            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            console.log(checkboxes); 
            checkboxes.forEach(function (checkbox) {
            selectedProductIds.push(parseInt(checkbox.value, 10));
        });

        // Make an AJAX request to the server
        $.ajax({
            type: "POST",
            url: "/categories/" + categoryId + "/updateProductRelation",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(selectedProductIds),
            success: function (response) {
                // Handle success response
                var successMessage = document.getElementById("success-message");
                successMessage.innerHTML = response;
                successMessage.style.display = "block";
            },
            error: function (error) {
                // Handle error response
                var errorMessage = document.getElementById("error-message");
                errorMessage.innerHTML = "紐付更新中にエラーが発生しました";
                errorMessage.style.display = "block";
            }
        });
    }
  </script>

   <!-- 課題１１ -->
    <button id="update-button" class="btn btn-primary">紐付更新</button>


    <a class="btn btn-secondary" th:href="@{/categories}"
      >カテゴリー一覧</a
    >
    <br />

      <!-- 課題１１ -->
    <script>
      document.getElementById("update-button").onclick = updateCategoryProducts;
    </script>

         <!-- 課題１１
    <script>
       $(document).ready(function() {
        $('input[type="checkbox"]').each(function() {
          var productId = $(this).val();
        
            // associatedProductIdsに含まれている場合、チェックを入れる
            if ($.inArray(productId, ${associatedProductIds}) !== -1) {
                $(this).prop('checked', true);
            }
        });
      });
    </script> -->


  </th:block>





</html>
<!-- <script src="/js/category/category-product.js"></script> -->